{"version":3,"file":"fetch.js","sourceRoot":"","sources":["fetch.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Promise from 'bluebird';\nimport settings from './settings';\nimport { GethConnector } from '@akashaproject/geth-connector';\nimport { constructed as contracts } from '../../contracts/index';\nimport { generalSettings, BASE_URL } from '../../config/settings';\nimport { getShortProfile } from '../profile/ipfs';\n\nlet chat;\nconst transform = Promise.coroutine(function*(data: { payload: string, sent: number, hash: string }) {\n    let obj, rootHash, userMedia;\n    let response = {\n        timeStamp: 0,\n        profileAddress: '',\n        messageHash: '',\n        [BASE_URL]: generalSettings.get(BASE_URL)\n    };\n    const utf = GethConnector.getInstance().web3.toUtf8(data.payload);\n    try {\n        obj = JSON.parse(utf);\n    } catch (err) {\n        obj = { message: '', akashaId: '' };\n    }\n    if (obj.akashaId) {\n        response.profileAddress = yield contracts.instance.registry.addressOf(obj.akashaId);\n        response.messageHash = data.hash;\n        rootHash = yield contracts.instance.profile.getIpfs(response.profileAddress);\n        userMedia = yield getShortProfile(rootHash);\n        response.timeStamp = data.sent;\n    }\n    return Object.assign({}, obj, response, userMedia);\n});\n\nconst execute = Promise.coroutine(function*(data: { stop?: boolean, channel?: string }, cb: any) {\n        if (data.stop) {\n            if (chat) {\n                chat.stopWatching(() => {\n                    chat = null;\n                });\n            }\n            return { watching: false };\n        }\n\n        if (data.channel && chat) {\n            chat.stopWatching(() => {\n                chat = null;\n            });\n            yield Promise.delay(250);\n        }\n        let current;\n        const collection = [];\n        const topic = (data.channel) ?\n            GethConnector.getInstance().web3.fromUtf8(data.channel) : settings.getDefaultTopic();\n        const channel = (data.channel) ? data.channel: null;\n        settings.setActive(topic);\n        // fetch initial messages\n        const initial = yield Promise.fromCallback((cb) => {\n            return (GethConnector.getInstance().web3.shh.filter({ topics: [topic] })).get(cb);\n        });\n        for (let i = 0; i < initial.length; i++) {\n            if (initial[i].hasOwnProperty('payload')) {\n                current = yield transform(initial[i]);\n                collection.push(current);\n            }\n        }\n        if (chat) {\n            return { collection, channel: channel };\n        }\n\n        cb(null, { collection, channel: channel });\n\n        // watch for new messages\n        chat = GethConnector.getInstance().web3.shh.filter({ topics: [topic] });\n        chat.watch(function (err, data) {\n            if (err) {\n                return cb(err);\n            }\n            if (data.hasOwnProperty('payload')) {\n                transform(data).then((message) => {\n                    cb(null, {message: message, channel: channel});\n                });\n            }\n        });\n\n        return { watching: true }\n    }\n);\n\nexport default { execute, name: 'fetch' };\n"]}