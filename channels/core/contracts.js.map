{"version":3,"file":"contracts.js","sourceRoot":"","sources":["contracts.ts"],"names":[],"mappings":"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","sourcesContent":["import * as BlPromise from 'bluebird';\nimport * as hash from 'object-hash';\nimport * as initContracts from '@akashaproject/contracts.js';\nimport { descend, filter, head, isNil, last, prop, sortWith, take, uniq } from 'ramda';\nimport { AUTH_MODULE, CORE_MODULE } from '@akashaproject/common/constants';\n\nexport default function init(sp, getService) {\n\n  class Contracts {\n    public instance: any;\n    public watchers: any[] = [];\n\n    /**\n     * Init web3 contract js bindings\n     */\n    public async init() {\n      this.instance = await initContracts(\n        getService(CORE_MODULE.WEB3_API).instance.currentProvider);\n    }\n\n    public reset() {\n      this.instance = null;\n    }\n\n    // send transaction and watch status\n    public send(data: any, token: string, cb) {\n      return (getService(AUTH_MODULE.auth)).signData(data.params[0], token)\n        .once('transactionHash', function (txHash) {\n          cb(null, { tx: txHash });\n        })\n        .once('error', function (error) {\n          cb(error);\n        });\n    }\n\n    public createWatcher(ethEvent: any, args: any, fromBlock: number) {\n      const currentWatcher = ethEvent(args, { fromBlock });\n      this.watchers.push(currentWatcher);\n      return currentWatcher;\n    }\n\n    public stopAllWatchers() {\n      this.watchers.forEach((watcher) => {\n        return watcher.stopWatching(() => {\n        });\n      });\n      this.watchers.length = 0;\n      return BlPromise.delay(1000);\n    }\n\n    public fromEvent(\n      ethEvent: any, args: any, toBlock: number | string, limit: number,\n      options: { lastIndex?: number, reversed?: boolean, stopOnFirst?: boolean },\n    ) {\n      const step = 5300;\n      const hashedEvent = hash(Array.from(arguments));\n      if (getService(CORE_MODULE.STASH).eventCache.hasFull(hashedEvent) &&\n        !options.reversed) {\n        return Promise.resolve(\n          getService(CORE_MODULE.STASH).eventCache.getFull(hashedEvent));\n      }\n      return new Promise((resolve, reject) => {\n        let results = [];\n        let filterIndex;\n        if (!options.reversed) {\n          filterIndex = (record) => record.blockNumber < toBlock ||\n            (record.blockNumber === toBlock && record.logIndex < options.lastIndex);\n        } else {\n          filterIndex = (record) => record.blockNumber > toBlock;\n        }\n\n        const fetch = (to) => {\n          let fromBlock = (options.reversed) ? toBlock : to - step;\n          if (fromBlock < 0) {\n            fromBlock = 0;\n          }\n          const event = ethEvent(\n            args,\n            { fromBlock, toBlock: (options.reversed) ? 'latest' : to });\n          event.get((err, data) => {\n            if (err) {\n              return reject(err);\n            }\n            const filteredData = (!isNil(options.lastIndex))\n              ? filter(filterIndex, data) : data; // @_@\n\n            results = uniq(results.concat(filteredData));\n            if (results.length < limit && fromBlock > 0 && !options.reversed) {\n              if (!options.stopOnFirst || !results.length) {\n                return fetch(fromBlock);\n              }\n            }\n\n            const sortedResults = take(\n              limit,\n              sortWith(\n                [\n                  descend(prop('blockNumber')),\n                  descend(prop('logIndex')),\n                ],\n                results),\n            );\n            const lastLog = options.reversed ?\n              head(sortedResults) : last(sortedResults);\n            const lastIndex = lastLog ? lastLog.logIndex : 0;\n            let lastBlock;\n            if (options.reversed) {\n              lastBlock = lastLog ? lastLog.blockNumber : fromBlock;\n            } else {\n              lastBlock = lastLog ?\n                (sortedResults.length === limit && fromBlock !== 0) ?\n                  lastLog.blockNumber : 0 : 0;\n            }\n            const result = { results: sortedResults, fromBlock: lastBlock, lastIndex };\n            getService(CORE_MODULE.STASH).eventCache.setFull(hashedEvent, result);\n            return resolve(result);\n          });\n        };\n        fetch(toBlock);\n      });\n\n    }\n\n    public fromEventFilter(ethEvent: any, args: any, toBlock: number | string, limit: number,\n                           options: { lastIndex?: number, reversed?: boolean },\n                           aditionalFilter: (data) => boolean) {\n      const step = 8300;\n      const hashedEvent = hash(Array.from(arguments));\n      if (getService(CORE_MODULE.STASH).eventCache.hasFull(hashedEvent) &&\n        !options.reversed) {\n        return Promise.resolve(\n          getService(CORE_MODULE.STASH).eventCache.getFull(hashedEvent));\n      }\n      return new Promise((resolve, reject) => {\n        let results = [];\n        let filterIndex;\n        if (!options.reversed) {\n          filterIndex = record => record.blockNumber < toBlock ||\n            (record.blockNumber === toBlock && record.logIndex < options.lastIndex);\n        } else {\n          filterIndex = record => record.blockNumber > toBlock;\n        }\n        const fetch = (to) => {\n          let fromBlock = (options.reversed) ? toBlock : to - step;\n          if (fromBlock < 0) {\n            fromBlock = 0;\n          }\n          const event = ethEvent(args, {\n            fromBlock,\n            toBlock: (options.reversed) ? 'latest' : to,\n          });\n          event.get((err, data) => {\n            if (err) {\n              return reject(err);\n            }\n\n            const filteredData = filter(aditionalFilter, filter(filterIndex, data));\n            results = uniq(results.concat(filteredData));\n            if (results.length < limit && fromBlock > 0 && !options.reversed) {\n              return fetch(fromBlock);\n            }\n\n            const sortedResults = take(\n              limit,\n              sortWith(\n                [\n                  descend(prop('blockNumber')),\n                  descend(prop('logIndex')),\n                ],\n                results));\n            const lastLog = options.reversed ?\n              head(sortedResults) : last(sortedResults);\n            const lastIndex = lastLog ? lastLog.logIndex : 0;\n            let lastBlock;\n            if (options.reversed) {\n              lastBlock = lastLog ? lastLog.blockNumber : fromBlock;\n            } else {\n              lastBlock = lastLog ?\n                (sortedResults.length === limit && fromBlock !== 0) ?\n                  lastLog.blockNumber : 0 : 0;\n            }\n            const result = { results: sortedResults, fromBlock: lastBlock, lastIndex };\n            getService(CORE_MODULE.STASH).eventCache.setFull(hashedEvent, result);\n            return resolve(result);\n          });\n        };\n        fetch(toBlock);\n      });\n\n    }\n\n  }\n\n  const contracts = new Contracts();\n  const service = function () {\n    return contracts;\n  };\n  sp().service(CORE_MODULE.CONTRACTS, service);\n\n}\n"]}