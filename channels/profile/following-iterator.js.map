{"version":3,"file":"following-iterator.js","sourceRoot":"","sources":["following-iterator.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Promise from 'bluebird';\nimport { COMMON_MODULE, CORE_MODULE, PROFILE_MODULE } from '@akashaproject/common/constants';\nimport { followersIteratorSchema } from './followers-iterator';\nimport { uniq } from 'ramda';\n\nexport default function init (sp, getService) {\n\n  const execute = Promise.coroutine(function* (data) {\n    const v = new (getService(CORE_MODULE.VALIDATOR_SCHEMA)).Validator();\n    v.validate(data, followersIteratorSchema, { throwError: true });\n\n    let lastFetchedBlock;\n    let remainingResults;\n    let fromIndex;\n    const collection = [];\n    const web3Api = getService(CORE_MODULE.WEB3_API);\n    const contracts = getService(CORE_MODULE.CONTRACTS);\n\n    const address = yield (getService(COMMON_MODULE.profileHelpers)).profileAddress(data);\n    const lastBlock = yield web3Api.instance.eth.getBlockNumber();\n    const toBlock = (!data.lastBlock) ? lastBlock : data.lastBlock;\n    const totalFollowing = yield contracts.instance.Feed.totalFollowing(address);\n    // If already loaded all results\n    if (totalFollowing <= data.totalLoaded) {\n      return {\n        collection,\n        lastBlock: 0,\n        lastIndex: 0,\n        akashaId: data.akashaId,\n        limit: data.limit,\n      };\n    }\n\n    let maxResults = totalFollowing.toString() === '0' ? 0 : data.limit || 5;\n    if (maxResults > totalFollowing.toNumber()) {\n      maxResults = totalFollowing.toNumber();\n    }\n\n    if (data.totalLoaded) {\n      const nextTotal = data.totalLoaded + maxResults;\n      if (nextTotal > totalFollowing) {\n        maxResults = totalFollowing - data.totalLoaded;\n      }\n    }\n    lastFetchedBlock = toBlock;\n    remainingResults = maxResults;\n    fromIndex = data.lastIndex;\n    while (collection.length < maxResults && lastFetchedBlock !== 0) {\n      const fetched = yield contracts.fromEvent(\n        contracts.instance.Feed.Follow, { follower: address },\n        lastFetchedBlock, remainingResults, { lastIndex: fromIndex });\n      for (const event of fetched.results) {\n        const follows = yield contracts.instance.Feed.follows(address, event.args.followed);\n        if (!follows) {\n          continue;\n        }\n        collection.push({ ethAddress: event.args.followed });\n        if (collection.length === maxResults) {\n          break;\n        }\n      }\n      lastFetchedBlock = fetched.fromBlock;\n      remainingResults = maxResults - collection.length;\n      fromIndex = fetched.lastIndex;\n    }\n    return {\n      collection: uniq(collection),\n      lastBlock: lastFetchedBlock,\n      lastIndex: fromIndex,\n      akashaId: data.akashaId,\n      limit: maxResults,\n    };\n  });\n  const followingIterator = { execute, name: 'followingIterator' };\n  const service = function () {\n    return followingIterator;\n  };\n  sp().service(PROFILE_MODULE.followingIterator, service);\n  return followingIterator;\n}\n"]}