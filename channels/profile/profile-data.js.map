{"version":3,"file":"profile-data.js","sourceRoot":"","sources":["profile-data.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Promise from 'bluebird';\nimport {\n  COMMON_MODULE,\n  CORE_MODULE,\n  GENERAL_SETTINGS,\n  PROFILE_MODULE,\n} from '@akashaproject/common/constants';\nimport { unpad } from 'ethereumjs-util';\n\nexport const getProfileDataSchema = {\n  id: '/getProfileData',\n  type: 'object',\n  properties: {\n    akashaId: { type: 'string' },\n    ethAddress: { type: 'string', format: 'address' },\n    short: { type: 'boolean' },\n    full: { type: 'boolean' },\n    resolveImages: { type: 'boolean' },\n  },\n};\n\nexport default function init (sp, getService) {\n\n  const execute: any = Promise.coroutine(function* (data: any, cb) {\n    const v = new (getService(CORE_MODULE.VALIDATOR_SCHEMA)).Validator();\n    v.validate(data, getProfileDataSchema, { throwError: true });\n\n    let profile;\n    let akashaId;\n    const web3Api = getService(CORE_MODULE.WEB3_API);\n    const contracts = getService(CORE_MODULE.CONTRACTS);\n    const settings = getService(CORE_MODULE.SETTINGS);\n    const dbIndex = getService(CORE_MODULE.DB_INDEX);\n    const followingCount = getService(PROFILE_MODULE.followingCount);\n    const followersCount = getService(PROFILE_MODULE.followersCount);\n    const resolveEthAddress = getService(PROFILE_MODULE.getByAddress);\n    const entryCountProfile = getService(PROFILE_MODULE.entryCountProfile);\n    const resolveProfile = getService(PROFILE_MODULE.resolveProfile);\n    const getShortProfile = getService(PROFILE_MODULE.getShortProfile);\n\n    const ethAddress = yield (getService(COMMON_MODULE.profileHelpers)).profileAddress(data);\n    if (data.ethAddress) {\n      const resolved = yield resolveEthAddress.execute({ ethAddress: data.ethAddress });\n      akashaId = resolved.akashaId;\n    }\n    akashaId = akashaId || data.akashaId;\n    const akashaIdHash = yield contracts.instance.ProfileRegistrar.hash(akashaId || '');\n    const [, , donationsEnabled,\n      fn, digestSize, hash] = yield contracts.instance.ProfileResolver.resolve(akashaIdHash);\n    const foCount = yield followingCount.execute({ ethAddress });\n    const fwCount = yield followersCount.execute({ ethAddress });\n    const entriesCount = yield entryCountProfile.execute({ ethAddress });\n    const commentsCount = yield contracts.instance.Comments.totalCommentsOf(ethAddress);\n    const [karma, essence] = yield contracts.instance.Essence.getCollected(ethAddress);\n    const partialProfile = {\n      akashaId,\n      ethAddress,\n      donationsEnabled,\n      followingCount: foCount.count,\n      followersCount: fwCount.count,\n      entriesCount: entriesCount.count,\n      commentsCount: commentsCount.toString(10),\n      [GENERAL_SETTINGS.BASE_URL]: settings.get(GENERAL_SETTINGS.BASE_URL),\n      karma: web3Api.instance.utils.fromWei(web3Api.instance.utils.toBN(karma), 'ether'),\n      essence: web3Api.instance.utils.fromWei(web3Api.instance.utils.toBN(essence), 'ether'),\n    };\n    cb('', partialProfile);\n    if (!!unpad(hash)) {\n      const ipfsHash = getService(COMMON_MODULE.ipfsHelpers).encodeHash(fn, digestSize, hash);\n      if (data.short) {\n        profile = { ipfsHash };\n      } else {\n        profile = (data.full) ?\n          yield resolveProfile(ipfsHash, data.resolveImages)\n            .timeout(settings.get(GENERAL_SETTINGS.FULL_WAIT_TIME) || 25000)\n            .then((d) => d).catch((e) => null)\n          :\n          yield getShortProfile(ipfsHash, data.resolveImages)\n            .timeout(settings.get(GENERAL_SETTINGS.OP_WAIT_TIME) || 15000)\n            .then((d) => d).catch((e) => null);\n      }\n\n      dbIndex.profiles.searchIndex.concurrentAdd(\n        {},\n        [{ akashaId, id: ethAddress }],\n        (err) => {\n          if (err) {\n            console.warn('error storing PROFILE index', err);\n          }\n        });\n    }\n\n    return Object.assign({}, partialProfile, profile);\n\n  });\n\n  const profileData = { execute, name: 'getProfileData', hasStream: true };\n  const service = function () {\n    return profileData;\n  };\n  sp().service(PROFILE_MODULE.profileData, service);\n  return profileData;\n\n}\n"]}