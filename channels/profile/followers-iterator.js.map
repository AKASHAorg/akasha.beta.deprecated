{"version":3,"file":"followers-iterator.js","sourceRoot":"","sources":["followers-iterator.ts"],"names":[],"mappings":"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","sourcesContent":["import * as Promise from 'bluebird';\nimport { COMMON_MODULE, CORE_MODULE, PROFILE_MODULE } from '@akashaproject/common/constants';\nimport { uniq } from 'ramda';\n\nexport const followersIteratorSchema = {\n  id: '/followersIterator',\n  type: 'object',\n  properties: {\n    ethAddress: { type: 'string', format: 'address' },\n    akashaId: { type: 'string' },\n    lastBlock: { type: 'number' },\n    limit: { type: 'number' },\n    totalLoaded: { type: 'number' },\n    lastIndex: { type: 'number' },\n  },\n};\n\nexport default function init(sp, getService) {\n\n  const execute = Promise.coroutine(function* (data) {\n    const v = new (getService(CORE_MODULE.VALIDATOR_SCHEMA)).Validator();\n    v.validate(data, followersIteratorSchema, { throwError: true });\n    let lastFetchedBlock;\n    let remainingResults;\n    let fromIndex;\n    const collection = [];\n    const web3Api = getService(CORE_MODULE.WEB3_API);\n    const contracts = getService(CORE_MODULE.CONTRACTS);\n\n    const address = yield (getService(COMMON_MODULE.profileHelpers)).profileAddress(data);\n    const lastBlock = yield web3Api.instance.eth.getBlockNumberAsync();\n    const toBlock = (!data.lastBlock) ? lastBlock : data.lastBlock;\n    const totalFollowers = yield contracts.instance.Feed.totalFollowers(address);\n    // If already loaded all results\n    if (totalFollowers <= data.totalLoaded) {\n      return {\n        collection,\n        lastBlock: 0,\n        lastIndex: 0,\n        akashaId: data.akashaId,\n        limit: data.limit,\n      };\n    }\n\n    let maxResults = totalFollowers.toString() === '0' ? 0 : data.limit || 5;\n    if (maxResults > totalFollowers.toNumber()) {\n      maxResults = totalFollowers.toNumber();\n    }\n    if (data.totalLoaded) {\n      const nextTotal = data.totalLoaded + maxResults;\n      if (nextTotal > totalFollowers) {\n        maxResults = totalFollowers - data.totalLoaded;\n      }\n    }\n    lastFetchedBlock = toBlock;\n    remainingResults = maxResults;\n    fromIndex = data.lastIndex;\n    while (collection.length < maxResults && lastFetchedBlock !== 0) {\n      const fetched = yield contracts.fromEvent(\n        contracts.instance.Feed.Follow, { followed: address },\n        lastFetchedBlock, remainingResults, { lastIndex: fromIndex });\n      for (const event of fetched.results) {\n        const follows = yield contracts.instance.Feed.follows(event.args.follower, address);\n        if (!follows) {\n          continue;\n        }\n\n        collection.push({ ethAddress: event.args.follower });\n        if (collection.length === maxResults) {\n          break;\n        }\n      }\n      lastFetchedBlock = fetched.fromBlock;\n      remainingResults = maxResults - collection.length;\n      fromIndex = fetched.lastIndex;\n    }\n\n    return {\n      collection: uniq(collection),\n      lastBlock: lastFetchedBlock,\n      lastIndex: fromIndex,\n      akashaId: data.akashaId,\n      limit: maxResults,\n    };\n  });\n  const followersIterator = { execute, name: 'followersIterator' };\n  const service = function () {\n    return followersIterator;\n  };\n  sp().service(PROFILE_MODULE.followersIterator, service);\n  return followersIterator;\n}\n"]}